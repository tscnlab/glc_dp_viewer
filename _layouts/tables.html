---
layout: default
---

{{ content }}

{% for table_schema_file in site.data["_tables"] %}
  {% assign table_schema = site.data[table_schema_file] %}
  {% assign table_schema_id = table_schema.name | default: table_schema_file %}

  <h2 id="{{ table_schema_id }}">{{ table_schema.title }}</h2>

  <p class="small">
    Source:
    <a href="{{ site.github.repository_url }}/blob/main/_data/{{ table_schema_file }}.json">
      <code>{{ table_schema_file }}.json</code>
    </a>
  </p>

{%- comment -%}
Compute inbound references to this schema section (table_schema_id):
- JSON Schema fields/properties with x-refersToSchema == table_schema_id
- (Optional) Table Schema foreignKeys where fk.reference.resource == table_schema_id
{%- endcomment -%}

{% assign inbound_refs = "" | split: "" %}

{% for other_file in site.data["_tables"] %}
  {% assign other_schema = site.data[other_file] %}
  {% assign other_id = other_schema.name | default: other_file %}

  {%- comment -%} 1) JSON Schema-style references via x-refersToSchema {%- endcomment -%}
  {% if other_schema.properties %}
    {% for kv in other_schema.properties %}
      {% assign prop_name = kv[0] %}
      {% assign prop = kv[1] %}
      {% if prop['x-refersToSchema'] == table_schema_id %}
        {% assign entry = other_id | append: "|" | append: prop_name %}
        {% assign inbound_refs = inbound_refs | push: entry %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {%- comment -%} 2) Table Schema FK references (only if you use them) {%- endcomment -%}
  {% if other_schema.foreignKeys %}
    {% for fk in other_schema.foreignKeys %}
      {% if fk.reference and fk.reference.resource == table_schema_id %}
        {% assign entry = other_id | append: "|" | append: fk.fields %}
        {% assign inbound_refs = inbound_refs | push: entry %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endfor %}

{% if inbound_refs.size > 0 %}
  <p class="small text-muted">
    Referenced by:
    {% for ref in inbound_refs %}
      {% assign parts = ref | split: "|" %}
      {% assign src_schema = parts[0] %}
      {% assign src_field = parts[1] %}
      <a href="{{ site.baseurl }}/data/#{{ src_schema }}.{{ src_field }}">
        <code>{{ src_schema }}</code>.<code>{{ src_field }}</code>
      </a>{% if forloop.last == false %}, {% endif %}
    {% endfor %}
  </p>
{% endif %}

  {{ table_schema.description | markdownify }}

  {% if table_schema.fields %}
    <!-- Frictionless Table Schema -->
    <table>
      <colgroup>
        <col width="25%">
        <col width="65%">
        <col width="10%">
      </colgroup>
      <thead>
        <tr>
          <th>Name</th>
          <th>Definition</th>
          <th>Type</th>
        </tr>
      </thead>
      <tbody>
        {% for field in table_schema.fields %}
          <tr class="text-break">
            <td id="{{ table_schema_id }}.{{ field.name }}">
              <a href="#{{ table_schema_id }}.{{ field.name }}"><code>{{ field.name }}</code></a>
              {% if field.constraints.required %}*{% endif %}
            </td>
            <td>
              {{ field.description | markdownify }}
              {% if field.constraints %}
                <strong>Constraints</strong>
                <ul>
                  {% for constraint in field.constraints %}
                    <li>{{ constraint[0] }}: <code>{{ constraint[1] | join: ", " }}</code></li>
                  {% endfor %}
                </ul>
              {% endif %}
              {% if field.example and field.example != "" %}
                <p><strong>Example</strong>: <code>{{ field.example }}</code></p>
              {% endif %}

              {% if table_schema.foreignKeys %}
                {% for fk in table_schema.foreignKeys %}
                 {% if fk.fields == field.name %}
                  <p class="small text-muted">
                    References:
                    <a href="{{ site.baseurl }}/data/#{{ fk.reference.resource }}.{{ fk.reference.fields }}">
                      <code>{{ fk.reference.resource }}</code>.<code>{{ fk.reference.fields }}</code>
                    </a>
                  </p>
                {% endif %}
              {% endfor %}
            {% endif %}
            </td>
            <td><span class="badge bg-secondary">{{ field.type }}</span></td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  {% elsif table_schema.properties %}
    <!-- JSON Schema -->
    {% include jsonschema_properties.html
       properties=table_schema.properties
       required=table_schema.required
       schema_id=table_schema_id %}
  {% else %}
    <p class="small text-muted">
      This schema has neither <code>fields</code> nor <code>properties</code> and cannot be rendered.
    </p>
  {% endif %}
{% endfor %}
